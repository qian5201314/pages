<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>简易热成像效果</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 0;
        margin: 0;
        font-family: Arial, sans-serif;
        color: #fff;
        background-color: #000;
      }

      .container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
      }

      #video {
        display: none;
      }

      #canvas {
        width: 100%;
        border: 2px solid #444;
        border-radius: 8px;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      button {
        padding: 10px 15px;
        font-size: 16px;
        color: white;
        cursor: pointer;
        background-color: #4a2f8a;
        border: none;
        border-radius: 5px;
      }

      button:hover {
        background-color: #5f3ca8;
      }

      .sensitivity-control {
        width: 100%;
        max-width: 500px;
        margin-top: 15px;
        text-align: center;
      }

      .sensitivity-control label {
        display: block;
        margin-bottom: 5px;
      }

      .sensitivity-control input {
        width: 80%;
      }

      .loading {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
      }

      .loading-text {
        font-size: 24px;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>简易热成像效果</h1>
    <div class="container">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="sensitivity-control">
      <label for="contrast">对比度调整</label>
      <input type="range" id="contrast" min="1" max="5" step="0.1" value="2" />
    </div>

    <div class="sensitivity-control">
      <label for="brightness">亮度调整</label>
      <input type="range" id="brightness" min="0" max="100" value="10" />
    </div>

    <div class="controls">
      <button id="startBtn">开始</button>
      <button id="switchCameraBtn">切换摄像头</button>
    </div>

    <div id="loading" class="loading">
      <div class="loading-text">加载中...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const video = document.getElementById('video')
        const canvas = document.getElementById('canvas')
        const ctx = canvas.getContext('2d')
        const startBtn = document.getElementById('startBtn')
        const switchCameraBtn = document.getElementById('switchCameraBtn')
        const contrastSlider = document.getElementById('contrast')
        const brightnessSlider = document.getElementById('brightness')
        const loadingElement = document.getElementById('loading')

        let stream = null
        let isProcessing = false
        let facingMode = 'environment' // 默认使用后置摄像头

        // 设置Canvas尺寸
        function setupCanvasSize() {
          canvas.width = video.videoWidth
          canvas.height = video.videoHeight
        }

        // 开始摄像头
        async function startCamera() {
          try {
            if (stream) {
              stopCamera()
            }

            loadingElement.style.display = 'flex'

            const constraints = {
              video: {
                facingMode: facingMode,
                width: { ideal: 1280 },
                height: { ideal: 720 },
              },
            }

            stream = await navigator.mediaDevices.getUserMedia(constraints)
            video.srcObject = stream

            return new Promise((resolve) => {
              video.onloadedmetadata = () => {
                setupCanvasSize()
                loadingElement.style.display = 'none'
                resolve()
              }
            })
          } catch (err) {
            console.error('摄像头访问错误:', err)
            alert('无法访问摄像头: ' + err.message)
            loadingElement.style.display = 'none'
          }
        }

        // 停止摄像头
        function stopCamera() {
          if (stream) {
            stream.getTracks().forEach((track) => track.stop())
            stream = null
          }
          isProcessing = false
        }

        // 处理视频帧
        function processFrame() {
          if (!isProcessing) return

          // 将视频帧绘制到Canvas
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height)

          // 获取图像数据
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
          const data = imageData.data

          // 获取当前对比度和亮度设置
          const contrast = parseFloat(contrastSlider.value)
          const brightness = parseInt(brightnessSlider.value)

          // 处理每个像素
          for (let i = 0; i < data.length; i += 4) {
            // 计算灰度值 (使用亮度公式: 0.299R + 0.587G + 0.114B)
            const r = data[i]
            const g = data[i + 1]
            const b = data[i + 2]
            let gray = 0.299 * r + 0.587 * g + 0.114 * b

            // 应用对比度
            gray = ((gray / 255 - 0.5) * contrast + 0.5) * 255

            // 应用亮度调整
            gray = Math.max(0, Math.min(255, gray + brightness))

            // 反转颜色 (255 - gray)，使暗区变亮，亮区变暗
            const invertedValue = 255 - gray

            // 根据反转后的值设置颜色
            // 暗区 (原本亮的) -> 紫色
            // 亮区 (原本暗的) -> 黄色
            if (invertedValue < 128) {
              // 偏暗区域 - 从紫色渐变
              const factor = invertedValue / 128
              data[i] = Math.floor(128 * factor) // R
              data[i + 1] = 0 // G
              data[i + 2] = Math.floor(255 * factor) // B
            } else {
              // 偏亮区域 - 从黄色渐变
              const factor = (invertedValue - 128) / 127
              data[i] = Math.floor(255 * factor) + 128 // R
              data[i + 1] = Math.floor(255 * factor) // G
              data[i + 2] = 0 // B
            }
          }

          // 将处理后的图像数据绘制回Canvas
          ctx.putImageData(imageData, 0, 0)

          // 请求下一帧
          requestAnimationFrame(processFrame)
        }

        // 开始按钮事件
        startBtn.addEventListener('click', async function () {
          if (!isProcessing) {
            await startCamera()
            isProcessing = true
            startBtn.textContent = '停止'
            processFrame()
          } else {
            stopCamera()
            startBtn.textContent = '开始'
          }
        })

        // 切换摄像头按钮事件
        switchCameraBtn.addEventListener('click', async function () {
          facingMode = facingMode === 'user' ? 'environment' : 'user'
          if (isProcessing) {
            await startCamera()
            processFrame()
          }
        })

        // 调整滑块事件 - 无需重新启动处理
        contrastSlider.addEventListener('input', function () {
          // 处理会在下一帧自动应用新设置
        })

        brightnessSlider.addEventListener('input', function () {
          // 处理会在下一帧自动应用新设置
        })

        // 页面卸载时停止摄像头
        window.addEventListener('beforeunload', stopCamera)

        // 隐藏加载提示
        loadingElement.style.display = 'none'
      })
    </script>
  </body>
